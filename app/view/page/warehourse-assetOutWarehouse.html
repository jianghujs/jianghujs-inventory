{% extends 'template/jhTemplateV3.html'%}

{% block vue_template %}


<jh-layout-v3>

  <template slot="serverSearch">
    <v-row class="ma-0 align-center flex-none pa-0" :class="{'pa-2': !isMobile, 'pa-2': isMobile}"
      style="justify-content: end">
      <v-col cols="12" sm="4" md="3" xl="2" class=" pb-3" :class="{'pb-xs-4': !isMobile, 'mt-2': isMobile}">
        <v-select v-model="tableGroupBy" :items="constantObj.tableGroupBy" prefix="展示类型"
          :class="{'mr-2': !isMobile}" hide-details dense filled single-line hide-no-data />
      </v-col>
      <v-col cols="12" sm="4" md="3" xl="2" class=" pb-3" :class="{'pb-xs-4': !isMobile, 'mt-2': isMobile}">
        <v-autocomplete prefix="商品" class="jh-v-input mr-2" dense filled single-line clearable
          v-model="serverSearchInput.goodId" :items="constantObj.good" item-text="goodName" item-value="goodId"
          :no-data-text="'没有数据'">
        </v-autocomplete>
      </v-col>
      <v-col cols="12" sm="4" md="3" xl="2" class=" pb-3" :class="{'pb-xs-4': !isMobile, 'mt-2': isMobile}">
        <v-autocomplete prefix="仓库" class="jh-v-input mr-2" dense filled single-line clearable
          v-model="serverSearchInput.warehouseId" :items="warehouseList" item-text="warehouseName"
          item-value="warehouseId" :no-data-text="'没有数据'">
      </v-col>
      <v-col :class="{'pt-2': isMobile, 'pl-0': isMobile, 'pr-0': !isMobile}" style="max-width: 77px">
        <v-btn class="elevation-0" color="success" dark @click="doUiAction('refreshTableData')">
          查询
        </v-btn>
      </v-col>
    </v-row>
  </template>

  <!-- 页面主要内容 -->
  <v-container class="fullScreen d-flex flex-column pa-xs-0 pa-0">
    <v-card>
      <v-row class="ma-0 pa-4"
        >

        <v-col cols="12" xs="4" sm="4" md="4" xl="4" class="pa-0">
          <span class="body-2">共{{ tableData.length }}条记录</span>
          <v-btn class="primary" @click="doUiAction('startReturn', {})">资产归还</v-btn>
        </v-col>

        <v-spacer></v-spacer>

        <v-col cols="12" xs="8" sm="4" md="3" xl="2" class="pa-0">
          <v-text-field v-model="searchInput" label="表格过滤" class="jh-v-input" dense filled single-line></v-text-field>
        </v-col>
      </v-row>
      <v-data-table fixed-header height="600" :headers="headers" :items="tableData" :search="searchInput"
        :group-by="tableGroupBy" :footer-props="{ itemsPerPageOptions: [20, 50, -1], itemsPerPageText: '每页行数', itemsPerPageAllText: '所有'}" :items-per-page="50"
        mobile-breakpoint="0" :loading="isTableLoading" checkbox-color="success"
        class="elevation-0 mt-0 mb-xs-4 flex-fill d-flex flex-column">
        <template v-slot:group.header="{items, isOpen, toggle, remove}">
          <th colspan="2">
            <v-icon @click="toggle">{{ isOpen ? 'mdi-minus' : 'mdi-plus' }}</v-icon>
            <span v-if="tableGroupBy === 'warehouseId'">
              仓库: {{ items[0].warehouseName }}
              <v-btn small class="success"
                @click="doUiAction('openAssetHistoryDialog', { item: items[0], assetHistoryViewType: 'warehouseId' } )">资产状态记录</v-btn>
            </span>
            <span v-if="tableGroupBy === 'goodId'">
              商品: {{ items[0].goodName }}
              <v-btn small class="success"
                @click="doUiAction('openAssetHistoryDialog', { item: items[0], assetHistoryViewType: 'goodId' } )">资产状态记录</v-btn>
            </span>
          </th>
          <th colspan="1">
            库存: {{ items.length }}
          </th>
        </template>

        <template v-slot:item.action="{ item }">
          <v-btn small class="success"
            @click="doUiAction('openAssetHistoryDialog', { item, assetHistoryViewType: 'assetId' } )">资产状态记录</v-btn>
          <v-btn v-if="item.assetOperation === '入库' || item.assetOperation === '归还'" small class="success"
            @click="doUiAction('startReceive', {item})">资产领取</v-btn>
        </template>
      </v-data-table>
    </v-card>
  </v-container>

  <!-- 资产状态记录 -->
  <v-navigation-drawer v-model="isAssetHistoryDrawerShow" hide-overlay :permanent="isAssetHistoryDrawerShow" app
    temporary right width="80%" class="elevation-24">
    <v-row class="pt-8">
      <span v-if="assetHistoryViewType === 'assetId'" class="title pa-6"
        :class="{'pl-12': !isMobile, 'pl-6': isMobile}">
        【资产维度: {{updateItem.assetId}}】资产状态记录
      </span>
      <span v-if="assetHistoryViewType === 'goodId'" class="title pa-6" :class="{'pl-12': !isMobile, 'pl-6': isMobile}">
        【商品维度: {{updateItem.goodName}}({{updateItem.goodId}})】资产状态记录
      </span>
      <span v-if="assetHistoryViewType === 'goodId'" class="title pa-6" :class="{'pl-12': !isMobile, 'pl-6': isMobile}">
        【仓库维度: {{updateItem.warehouseName}}({{updateItem.warehouseId}})】资产状态记录
      </span>
      <v-spacer></v-spacer>
      <v-btn class="mt-6 elevation-0" :class="{'mr-16': !isMobile, 'mr-8': isMobile}" fab x-small
        @click="isAssetHistoryDrawerShow = false">
        <v-icon dark>mdi-close</v-icon>
      </v-btn>
    </v-row>
    <v-row class="mt-0 px-4">
      <v-col cols="12" :class="{'pa-0': isMobile, 'px-4': isMobile, 'pt-6': isMobile}">
        <assetOutWarehouse-assetHistory :asset="updateItem" :view-type="assetHistoryViewType"
          v-if="isAssetHistoryDrawerShow"></assetOutWarehouse-assetHistory>
      </v-col>
    </v-row>
  </v-navigation-drawer>

  <!-- 领取 -->
  <v-navigation-drawer v-model="isReceiveDrawerShow" :permanent="isReceiveDrawerShow" fixed temporary right width="80%"
    class="elevation-24">
    <v-form v-model="isFormValid" v-if="isReceiveDrawerShow" ref="form" lazy-validation>
      <v-row class="pt-8">
        <span class="title pa-6"
          :class="{'pl-12': !isMobile, 'pl-6': isMobile}">【{{receiveItem.assetId}}({{receiveItem.goodName}})】资产领取</span>
        <v-spacer></v-spacer>
        <v-btn class="mt-6 elevation-0" :class="{'mr-16': !isMobile, 'mr-8': isMobile}" fab x-small
          @click="isReceiveDrawerShow = false">
          <v-icon dark>mdi-close</v-icon>
        </v-btn>
      </v-row>
      <v-row class="mt-0 px-4">


        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">资产编号</span>
          <v-text-field class="jh-v-input " dense filled single-line v-model="receiveItem['assetId']"
            :rules="requireRules" disabled="true"></v-text-field>
        </v-col>

        <v-col cols="12"></v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">仓库</span>
          <v-text-field class="jh-v-input " dense filled single-line v-model="receiveItem['warehouseName']"
            disabled="true"></v-text-field>
        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">货架</span>
          <v-text-field class="jh-v-input " dense filled single-line v-model="receiveItem['stockName']"
            disabled="true"></v-text-field>
        </v-col>
        <v-col cols="12"></v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">领取人</span>
          <v-text-field class="jh-v-input " dense filled single-line v-model="receiveItem['assetOperationUser']"
            :rules="requireRules"></v-text-field>
        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">领用人部门</span>
          <v-autocomplete class="jh-v-input mr-2" dense filled single-line clearable
            v-model="receiveItem.assetOperationDeptId" :items="deptList" item-text="deptName" item-value="deptId"
            :rules="requireRules">
          </v-autocomplete>

        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">备注</span>
          <v-text-field class="jh-v-input" dense filled single-line v-model="receiveItem['remark']"></v-text-field>
        </v-col>
      </v-row>
      <v-row class="justify-end mx-0 mt-8 px-6">
        <v-btn color="success" @click="doUiAction('receiveAsset')">领取</v-btn>
        <v-btn class="ml-2" @click="isReceiveDrawerShow = false">取消</v-btn>
      </v-row>
    </v-form>
  </v-navigation-drawer>


  <!-- 归还 -->
  <v-navigation-drawer v-model="isReturnDrawerShow" :permanent="isReturnDrawerShow" fixed temporary right width="80%"
    class="elevation-24">
    <v-form v-model="isFormValid" v-if="isReturnDrawerShow" ref="form" lazy-validation>
      <v-row class="pt-8">
        <span class="title pa-6" :class="{'pl-12': !isMobile, 'pl-6': isMobile}">资产归还</span>
        <v-spacer></v-spacer>
        <v-btn class="mt-6 elevation-0" :class="{'mr-16': !isMobile, 'mr-8': isMobile}" fab x-small
          @click="isReturnDrawerShow = false">
          <v-icon dark>mdi-close</v-icon>
        </v-btn>
      </v-row>
      <v-row class="mt-0 px-4">
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">资产选择</span>
          <v-autocomplete class="jh-v-input mr-2" dense filled single-line clearable v-model="returnItem.assetId"
            :items="returnItem.waittingReturnAssetList" item-text="text" item-value="value" :no-data-text="'没有数据'"
            :rules="requireRules" @change="(assetId) => {
              const asset = returnItem.waittingReturnAssetList.find(a => a.assetId === assetId);
              returnItem.warehouseId = asset.warehouseId;
              returnOfWarehouseSelectChange(asset.warehouseId);
              returnItem.stockId = asset.stockId;
            }">
          </v-autocomplete>
        </v-col>
        <v-col cols="12"></v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">仓库</span>
          <v-autocomplete class="jh-v-input mr-2" dense filled single-line clearable v-model="returnItem.warehouseId"
            :items="warehouseList" item-text="warehouseName" item-value="warehouseId" :rules="requireRules"
            @change="returnOfWarehouseSelectChange">
          </v-autocomplete>
        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">货架</span>
          <v-select v-model="returnItem.stockId" :items="stockList" :class="{'mr-2': !isMobile}" hide-details dense
            filled single-line hide-no-data item-text="stockName" item-value="stockId" :no-data-text="'没有数据'" />
        </v-col>
        <v-col cols="12"></v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">归还人</span>
          <v-text-field class="jh-v-input " dense filled single-line v-model="returnItem['assetOperationUser']"
            :rules="requireRules"></v-text-field>
        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">归还人部门</span>
          <v-autocomplete class="jh-v-input mr-2" dense filled single-line clearable
            v-model="returnItem.assetOperationDeptId" :items="deptList" item-text="deptName" item-value="deptId"
            :rules="requireRules">
          </v-autocomplete>
        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label">备注</span>
          <v-text-field class="jh-v-input" dense filled single-line v-model="returnItem['remark']"></v-text-field>
        </v-col>
      </v-row>
      <v-row class="justify-end mx-0 mt-8 px-6">
        <v-btn color="success" @click="doUiAction('returnAsset')">归还</v-btn>
        <v-btn class="ml-2" @click="isReturnDrawerShow = false">取消</v-btn>
      </v-row>
    </v-form>
  </v-navigation-drawer>



</jh-layout-v3>

{% endblock %}

{% block vue_body %}
{% include 'component/assetOutWarehouse-assetHistory.html' %}

<script type="module">
  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    data: () => ({
      // 表格相关数据
      isFormValid: true,
      requireRules: [
        v => !!v || '必填',
      ],
      constantObj: {
        tableGroupBy: [
          { text: '按仓库', value: 'warehouseId' },
          { text: '按商品', value: 'goodId' },
        ],
      },

      serverSearchInput: {
        goodCategory: ['固定资产', '一般资产'],
        warehouseId: null,
        goodId: null,
      },
      searchInput: null,
      isTableLoading: true,
      tableDataFromBackend: [],
      headers: [
        { text: "资产编号", value: "assetId", width: 150, class: 'fixed', cellClass: 'fixed' },
        { text: "商品名称", value: "goodName", width: 150, class: 'fixed', cellClass: 'fixed' },
        { text: "仓库", value: "warehouseName", width: 150 },
        { text: "货架", value: "stockName", width: 120 },

        { text: "资产状态", value: "assetOperation", width: 120 },
        { text: "资产操作人", value: "assetOperationUser", width: 120 },

        { text: "商品类型", value: "goodType", width: 120 },
        { text: "商品分类", value: "goodCategory", width: 120 },
        { text: "保质期", value: "expirationAt", width: 120 },
        { text: "入库时间", value: "storeAt", width: 260 },
        { text: "采购单", value: "purchaseOrderId", width: 150 },
        { text: "备注", value: "remark", width: 120 },
        // {text: "商品描述", value: "goodDesc", width: 150}, 
        { text: '操作', value: 'action', align: 'left', sortable: false, width: 260, class: 'fixed', cellClass: 'fixed' },
      ],
      updateItem: {},
      isAssetHistoryDrawerShow: false,

      tableGroupBy: 'warehouseId',
      assetHistoryViewType: null,

      receiveItem: {},
      isReceiveDrawerShow: false,

      returnItem: {},
      isReturnDrawerShow: false,

      warehouseList: [],
      stockList: [],
      deptList: [],
    }),
    computed: {
      isMobile() {
        return window.innerWidth < 600;
      },
      tableData() {
        return this.tableDataFromBackend;
      }
    },
    watch: {},
    async created() {
      await this.doUiAction('initConstantCollection');
      await this.doUiAction('refreshTableData');
    },
    mounted() { },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'initConstantCollection':
            await this.selectGoodList();
            await this.selectWarehouseList();
            await this.selectDeptList();
            break;
          case 'refreshTableData':
            await this.refreshTableData();
            break;
          case 'openAssetHistoryDialog':
            await this.openAssetHistoryDialog(uiActionData);
            break;
          case 'startReceive':
            await this.prepareReceiveData(uiActionData);
            await this.openReceiveDialog();
            break;
          case 'receiveAsset':
            await this.prepareValidate();
            await this.confirmReceiveAssetDialog();
            await this.doReceiveAsset();
            await this.closeDrawerShow();
            await this.refreshTableData();
            break;
          case 'startReturn':
            await this.prepareReturnData(uiActionData);
            await this.openReturnDialog();
            break;
          case 'returnAsset':
            await this.prepareValidate();
            await this.confirmReturnAssetDialog();
            await this.doReturnAsset();
            await this.closeDrawerShow();
            await this.refreshTableData();
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      // =================================uiAction 公共方法 start ======================================
      /**
       * uiActionId:  prepareValidate
       * description: ✅表单校验
      */
      async prepareValidate() {
        if (this.$refs.form.validate() === false) {
          window.vtoast.fail({ message: "输入有误, 请检查!" });
          throw new Error("[prepareValidate] false");
        }
      },

      /**
       * uiActionId:  refreshTableData
       * description: ✅获取表格数据
      */
      async refreshTableData() {
        this.isTableLoading = true;
        const where = {};
        if (this.serverSearchInput.goodId) {
          where.goodId = this.serverSearchInput.goodId;
        }
        if (this.serverSearchInput.warehouseId) {
          where.warehouseId = this.serverSearchInput.warehouseId;
        }
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'selectItemList',
              actionData: {},
              where,
              whereIn: {
                goodCategory: this.serverSearchInput.goodCategory,
              },
              // whereOptions: [
              //   ['storeCountOfConsume', '>', 0],
              // ],
              orderBy: [{ column: 'operationAt', order: 'desc' }]
            }
          }
        });
        const { rows } = result.data.appData.resultData;

        this.tableDataFromBackend = rows;
        this.isTableLoading = false;
      },
      async selectGoodList() {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'selectGoodList',
              actionData: {},
              whereIn: { goodCategory: this.serverSearchInput.goodCategory },
              where: { rowStatus: '正常' },
              orderBy: [{ column: 'goodName', order: 'desc' }]
            }
          }
        });
        const { rows } = result.data.appData.resultData;
        this.constantObj.good = rows;
      },
      async selectWarehouseList() {
        const warehouseList = (await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'selectWarehouseList',
              actionData: {},
              where: { rowStatus: '正常' },
            }
          }
        })).data.appData.resultData.rows;
        const allStockList = (await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'selectStockList',
              actionData: {},
              where: { rowStatus: '正常' },
            }
          }
        })).data.appData.resultData.rows;
        warehouseList.forEach(wh => {
          wh.stockList = allStockList.filter(stock => wh.warehouseId === stock.warehouseId);
        });
        this.warehouseList = warehouseList;
      },
      async selectDeptList() {
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'selectDeptList',
              actionData: {},
              orderBy: [{ column: 'deptName', order: 'desc' }]
            }
          }
        });
        const { rows } = result.data.appData.resultData;
        this.deptList = rows;
      },
      // =================================uiAction 公共方法 end ======================================
      async openAssetHistoryDialog({ item, assetHistoryViewType }) {
        this.updateItem = item;
        this.isAssetHistoryDrawerShow = true;
        this.assetHistoryViewType = assetHistoryViewType;
      },
      // ====================================领取=========================================
      async prepareReceiveData({ item }) {
        const { assetOperation, assetOperationUser, remark, ...receiveItem } = item;
        this.receiveItem = receiveItem
      },
      async openReceiveDialog() {
        this.isReceiveDrawerShow = true;
      },
      async confirmReceiveAssetDialog() {
        if (await window.confirmDialog({ title: "领取", content: "确定领取吗？" }) === false) {
          throw new Error("取消");
        }
      },
      async doReceiveAsset() {
        const { id, assetId, assetOperationUser, assetOperationDeptId, remark } = this.receiveItem;
        const assetOperation = '领取';
        await window.vtoast.loading("资产领取");
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'assetOperation',
              actionData: {
                assetId,
                assetOperation, assetOperationUser, assetOperationDeptId, remark
              },
            }
          }
        })
        await window.vtoast.success("资产领取成功");
      },
      // ====================================归还=========================================
      async prepareReturnData({ }) {
        this.stockList = [];
        this.returnItem = {};
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'selectItemList',
              actionData: {},
              where: {
                assetOperation: '领取',
              },
            }
          }
        });
        const { rows } = result.data.appData.resultData;
        rows.map(row => {
          row.text = `${row.goodName}(${row.assetId})`;
          row.value = row.assetId;
        })
        this.returnItem.waittingReturnAssetList = rows;
      },
      async openReturnDialog() {
        this.isReturnDrawerShow = true;
      },
      async confirmReturnAssetDialog() {
        if (await window.confirmDialog({ title: "归还", content: "确定归还吗？" }) === false) {
          throw new Error("取消");
        }
      },
      async doReturnAsset() {
        const { id, assetId, warehouseId, stockId, assetOperationUser, assetOperationDeptId, remark } = this.returnItem;
        const assetOperation = '归还';
        await window.vtoast.loading("资产归还");
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'assetOutWarehouse',
              actionId: 'assetOperation',
              actionData: {
                assetId, warehouseId, stockId, assetOperation, assetOperationUser, assetOperationDeptId, remark
              },
            }
          }
        })
        await window.vtoast.success("资产归还成功");
      },
      async closeDrawerShow() {
        this.isReceiveDrawerShow = false;
        this.isReturnDrawerShow = false;
      },

      async returnOfWarehouseSelectChange(warehouseId) {
        this.returnItem.stockId = null;
        const wh = this.warehouseList.find(wh => wh.warehouseId === warehouseId);
        this.stockList = wh.stockList;
      },
    }
  })
</script>

<style>
  .theme--light.v-data-table>.v-data-table__wrapper>table>tbody>tr>td:not(.v-data-table__mobile-row) {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 500px;
  }

  .theme--light.v-data-table>.v-data-table__wrapper>table>tbody>tr {
    cursor: pointer;
  }
</style>
{% endblock %}